# 威胁情报平台(TIP) 本地开发环境配置指南

## 1. 环境概述

本项目使用Docker Compose来管理本地开发所需的全部核心依赖服务，包括：

- **PostgreSQL**: 关系型数据库，用于存储用户信息、案例、配置、情报元数据等
- **Elasticsearch**: 搜索引擎，用于IOC快速检索、全文搜索、聚合分析，以及审计日志存储
- **Kibana**: Elasticsearch的可视化管理工具
- **Kafka**: 消息队列，用于微服务间的异步通信和解耦
- **Kafka UI**: Kafka的可视化管理工具
- **Redis**: 缓存服务，用于缓存常用富化结果、高频查询等
- **Neo4j**: 图数据库，用于关联分析和可视化
- **MinIO**: S3兼容的对象存储，用于存储案例附件、报告文件等
- **Nginx**: API网关，用于统一API入口、路由、负载均衡等

## 2. 前置条件

确保已安装以下软件：

- Docker (20.10.0+)
- Docker Compose (2.0.0+)
- Git
- Make（可选，但推荐安装）

## 3. 启动开发环境

### 3.1 使用Make命令（推荐）

项目根目录中的Makefile提供了便捷的命令来管理开发环境。

```bash
# 启动所有依赖服务
make dev-env-up

# 查看服务状态
make dev-env-status

# 查看服务日志
make dev-env-logs

# 停止所有服务
make dev-env-down

# 重启所有服务
make dev-env-restart
```

### 3.2 使用Docker Compose命令

如果您没有安装Make，可以直接使用Docker Compose命令：

```bash
# 启动所有依赖服务
docker-compose up -d

# 查看服务状态
docker-compose ps

# 查看服务日志
docker-compose logs -f

# 停止所有服务
docker-compose down

# 重启所有服务
docker-compose restart
```

## 4. 服务访问信息

启动所有服务后，可以通过以下地址访问各个服务：

### 4.1 数据库服务

- **PostgreSQL**
  - 主机: localhost
  - 端口: 5432
  - 用户名: tip_user
  - 密码: tip_password
  - 数据库: tip_db
  - 连接URL: `postgres://tip_user:tip_password@localhost:5432/tip_db`

- **Elasticsearch**
  - URL: http://localhost:9200
  - 安全认证: 未启用（开发环境）

- **Redis**
  - 主机: localhost
  - 端口: 6379
  - 无密码（开发环境）

- **Neo4j**
  - 浏览器界面: http://localhost:7474
  - Bolt URL: bolt://localhost:7687
  - 用户名: neo4j
  - 密码: tip_password

### 4.2 消息队列服务

- **Kafka**
  - 主题清单: raw-intelligence, processed-intelligence, enrichment-requests, enrichment-results, notifications, alerts, audit-logs
  - Bootstrap Servers: localhost:9093
  - Zookeeper: localhost:2181

- **Kafka UI**
  - 管理界面: http://localhost:8080

### 4.3 存储服务

- **MinIO**
  - API URL: http://localhost:9000
  - 控制台: http://localhost:9001
  - 访问密钥: minioadmin
  - 密钥: minioadmin
  - 存储桶: case-attachments, reports, ioc-exports

### 4.4 其他服务

- **Kibana**
  - 界面: http://localhost:5601

- **Nginx API网关**
  - 端口: http://localhost:8000
  - 健康检查: http://localhost:8000/health
  - API路径前缀: http://localhost:8000/api/
  - 前端应用路径: http://localhost:8000/app/

## 5. 微服务本地运行指南

### 5.1 Go后端服务

每个Go微服务需要在各自的目录中运行。以下是通用的运行步骤：

```bash
# 进入微服务目录
cd service/[service-name]

# 安装依赖
go mod download

# 运行服务（以开发模式）
go run main.go --config=config/dev.yaml
```

#### 5.1.1 服务配置示例

在每个Go微服务的`config/dev.yaml`文件中配置连接信息：

```yaml
server:
  port: [unique-port]  # 每个服务使用不同的端口

database:
  postgres:
    host: localhost
    port: 5432
    user: tip_user
    password: tip_password
    dbname: tip_db
    sslmode: disable
  
  elasticsearch:
    urls: ["http://localhost:9200"]
  
  redis:
    addr: "localhost:6379"
    password: ""
    db: 0
  
  neo4j:
    url: "bolt://localhost:7687"
    username: "neo4j"
    password: "tip_password"

kafka:
  brokers: ["localhost:9093"]
  consumer_group: "[service-name]-group"

minio:
  endpoint: "localhost:9000"
  accessKey: "minioadmin"
  secretKey: "minioadmin"
  useSSL: false
```

### 5.2 Vue前端应用

```bash
# 进入前端目录
cd frontend

# 安装依赖
npm install

# 启动开发服务器
npm run dev
```

#### 5.2.1 前端环境变量配置

在前端目录的`.env.development`文件中配置API地址：

```
# API地址（通过Nginx API网关）
VITE_API_BASE_URL=http://localhost:8000/api
```

## 6. 端口分配约定

为避免端口冲突，我们按以下方式分配端口：

- **基础设施服务**：详见第4节中的端口列表
- **Go后端微服务**：3000-3999范围
  - Auth Service: 3000
  - Ingestion Service: 3001
  - Processing Service: 3002
  - Analysis Service: 3003
  - Application Service: 3004
  - Visualization Service: 3005
  - Admin Service: 3006
- **Vue前端服务**：8888 (与基础设施服务区分开)

## 7. 常见问题排查

### 7.1 服务未能正常启动

检查服务状态和日志：

```bash
# 检查容器状态
docker-compose ps

# 查看特定服务的日志
docker-compose logs [service-name]
```

### 7.2 数据库连接问题

确保PostgreSQL服务已启动且配置正确：

```bash
# 检查PostgreSQL容器状态
docker-compose ps postgres

# 进入PostgreSQL容器测试连接
docker exec -it tip-postgres psql -U tip_user -d tip_db
```

### 7.3 消息队列问题

检查Kafka和Zookeeper服务：

```bash
# 检查Kafka主题列表
docker exec -it tip-kafka kafka-topics --bootstrap-server kafka:9092 --list
```

### 7.4 环境重置

如需完全重置开发环境（将删除所有数据）：

```bash
docker-compose down -v
docker-compose up -d
```

## 8. 开发最佳实践

1. **定期提交代码**：使用Git分支策略，遵循项目的提交规范
2. **保持服务独立**：每个微服务应当可以独立开发和测试
3. **统一接口规范**：遵循RESTful API设计原则
4. **日志记录**：使用统一的日志格式，便于追踪与排查问题
5. **配置外部化**：所有配置项应从配置文件或环境变量获取，不硬编码
6. **写单元测试**：为核心功能编写单元测试，使用`go test`或Vue的测试工具

## 9. 其他资源

- [数据库详细设计文档](../detail/数据库详细设计文档.md)
- [关键接口详细规范文档](../detail/关键接口详细规范文档.md)
- [核心算法设计文档](../detail/核心算法设计文档.md)